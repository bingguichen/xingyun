<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dstz.adaptor.org.xingyun.dao.UserDao">
  <resultMap id="UserDto" type="com.dstz.adaptor.org.xingyun.dto.UserDTO">
    <id property="userId" column="id" jdbcType="VARCHAR"/>
    <result property="fullname" column="name" jdbcType="VARCHAR"/>
    <result property="account" column="username" jdbcType="VARCHAR"/>
    <result property="password" column="password" jdbcType="VARCHAR"/>
    <result property="email" column="email" jdbcType="VARCHAR"/>
    <result property="mobile" column="telephone" jdbcType="VARCHAR"/>
    <result property="weixin" column="weixin" jdbcType="VARCHAR"/>
    <result property="status" column="available" jdbcType="NUMERIC"/>
  </resultMap>

  <resultMap id="UserRoleDto" type="com.dstz.adaptor.org.xingyun.dto.UserRoleDTO">
    <id property="roleId" column="role_id" jdbcType="VARCHAR"/>
    <result property="alias" column="role_code" jdbcType="VARCHAR"/>
    <result property="account" column="username" jdbcType="VARCHAR"/>
    <result property="fullname" column="name" jdbcType="VARCHAR"/>
    <result property="roleName" column="role_name" jdbcType="VARCHAR"/>
    <result property="userId" column="user_id" jdbcType="VARCHAR"/>
  </resultMap>

  <select id="getUserById" resultMap="UserDto">
    select id,
           name,
           username,
           password,
           email,
           telephone,
           '' as weixin,
           available
    FROM sys_user
    WHERE id = #{userId}
  </select>

  <select id="getUserByAccount" resultMap="UserDto">
    select id,
           name,
           username,
           password,
           email,
           telephone,
           '' as weixin,
           available
    FROM sys_user
    WHERE username = #{account}
  </select>

  <select id="getUserRole" resultMap="UserRoleDto">
    SELECT r.id   AS role_id,
           r.code AS role_code,
           u.username,
           u.name,
           r.name AS role_name,
           u.id   AS user_id
    FROM sys_user_role AS ur
           INNER JOIN sys_user AS u ON u.id = ur.user_id
           INNER JOIN sys_role AS r ON r.id = ur.role_id
    WHERE ur.user_id = #{userId}
      AND r.available = TRUE
    ORDER BY r.code
  </select>

  <select id="getUserByPositionId" resultMap="UserDto">
    SELECT u.id,
           u.name,
           u.username,
           u.password,
           u.email,
           u.telephone,
           '' as weixin,
           u.available
    FROM sys_user_position AS up
           INNER JOIN sys_user AS u ON u.id = up.user_id
           INNER JOIN sys_position AS p ON p.id = up.position_id
    WHERE up.position_id = #{positionId}
      AND p.available = TRUE
    ORDER BY p.code
  </select>

  <select id="getUserByPositionIds" resultMap="UserDto">
    SELECT u.id, u.name, u.username, u.password, u.email, u.telephone, '' as weixin, u.available
    FROM sys_user_position AS up
    INNER JOIN sys_user AS u ON u.id = up.user_id
    INNER JOIN sys_position AS p ON p.id = up.position_id
    WHERE up.position_id IN
    <foreach collection="positionIds" open="(" separator="," close=")" item="item">#{item}</foreach>
    AND p.available = TRUE
    ORDER BY p.code
  </select>

  <select id="getUserByRoleId" resultMap="UserDto">
    SELECT u.id,
           u.name,
           u.username,
           u.password,
           u.email,
           u.telephone,
           '' as weixin,
           u.available
    FROM sys_user_role AS ur
           INNER JOIN sys_user AS u ON u.id = ur.user_id
           INNER JOIN sys_role AS r ON r.id = ur.role_id
    WHERE ur.role_id = #{roleId}
      AND r.available = TRUE
    ORDER BY r.code
  </select>
</mapper>